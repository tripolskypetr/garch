# Особенности генерации выборки для каждой модели

`predict()` автоматически подбирает модель по AIC: фитит все 5 моделей и выбирает с наименьшим AIC.
Ниже — какие паттерны в данных лучше всего подходят каждой модели.

---

## GARCH(1,1)

**Когда выбирается:** волатильность кластеризуется симметрично — за большим движением (вверх или вниз) следует повышенная волатильность, затем она затухает.

**Рекурсия:**
```
σ²_t = ω + α·ε²_{t-1} + β·σ²_{t-1}
```

**Характер данных:**
- Нет разницы между реакцией на рост и падение
- Волатильность «вспыхивает» после любого резкого движения
- Постепенное затухание (mean-reversion) обратно к среднему уровню
- Стационарный процесс: `α + β < 1`

**Пример из реального мира:**
Спокойный рынок, где шоки вверх и вниз одинаково увеличивают неопределённость.

**DGP в тестах:**
```
ω = 1e-5, α = 0.10, β = 0.85
persistence = 0.95
```
Симметричная OHLC-генерация — high/low пропорциональны σ одинаково.

---

## EGARCH

**Когда выбирается:** сильный leverage-эффект — падение цены увеличивает волатильность значительно больше, чем рост на ту же величину.

**Рекурсия:**
```
ln(σ²_t) = ω + α·(|z_{t-1}| - E|z|) + γ·z_{t-1} + β·ln(σ²_{t-1})
```
где `γ < 0` — коэффициент leverage.

**Характер данных:**
- Падения вызывают больший всплеск волатильности, чем ростовые движения
- Логарифмическая модель: variance не может стать отрицательной (не нужен constraint α ≥ 0)
- Асимметричная реакция на знак шока

**Пример из реального мира:**
Фондовый рынок — обвал акций вызывает панику и рост волатильности,
а такой же по модулю рост воспринимается спокойно.

**DGP в тестах:**
```
ω = -0.3, α = 0.15, γ = -0.12, β = 0.93
```
При `z < 0` OHLC-диапазон расширяется в 1.5× (leverageBoost), при `z > 0` — сужается до 0.8×.

---

## GJR-GARCH (Glosten-Jagannathan-Runkle)

**Когда выбирается:** после падения цены волатильность растёт сильнее, чем после роста, но не так драматично как в EGARCH. Модель просто добавляет бонус к волатильности когда доходность отрицательная (переключатель: упало — добавить, выросло — не добавлять).

**Рекурсия:**
```
σ²_t = ω + α·ε²_{t-1} + γ·ε²_{t-1}·I(r_{t-1} < 0) + β·σ²_{t-1}
```
где `I(r < 0) = 1` если доходность отрицательная, иначе 0.

**Характер данных:**
- Умеренная асимметрия: при падении волатильность получает доп. импульс `+γ·ε²`
- Проще EGARCH — линейная модель с «переключателем»
- При `γ = 0` сводится к обычному GARCH

**Пример из реального мира:**
Актив с умеренным leverage-эффектом — крипто-токен, где падения чуть больше увеличивают волатильность, но без паники уровня фондового рынка.

**DGP в тестах:**
```
ω = 2e-5, α = 0.05, γ = 0.12, β = 0.82
persistence = α + γ/2 + β = 0.93
```

---

## HAR-RV (Heterogeneous Autoregressive Realized Volatility)

**Когда выбирается:** волатильность определяется несколькими масштабами времени — дневным, недельным и месячным компонентами.

**Рекурсия:**
```
RV_{t+1} = β₀ + β₁·RV_t + β₂·RV^(5)_t + β₃·RV^(22)_t
```
где `RV^(k)` — среднее RV за последние k периодов.

**Характер данных:**
- Волатильность вчера влияет на сегодня, но средняя за неделю и за месяц тоже влияют
- Нет параметрической модели — просто линейная регрессия по трём масштабам
- Использует Parkinson realized variance из OHLC (а не `r²`)
- Особенно полезна когда разные «горизонты» (дейтрейдеры, свинг, институционалы) двигают рынок

**Пример из реального мира:**
BTC/USDT на часовых свечках — микроструктура (дневная), недельный цикл (выходные vs будни), месячный тренд (халвинг-циклы) одновременно влияют на волатильность.

**DGP в тестах:**
```
β₀ = 1e-5, β₁ = 0.4 (daily), β₂ = 0.25 (weekly), β₃ = 0.25 (monthly)
persistence = β₁ + β₂ + β₃ = 0.9
```
OHLC генерируется через обратную формулу Паркинсона: `ln(H/L) = √(4·ln2·RV)`, чтобы Parkinson-оценка точно восстанавливала истинную RV.

---

## NoVaS (Normalizing and Variance-Stabilizing)

**Когда выбирается:** волатильность меняется непараметрически — плавные тренды, смена режимов, синусоидальные паттерны. Случаи, когда параметрические модели (GARCH-семейство) переобучаются.

**Рекурсия:**
```
σ²_t = a₀ + a₁·X²_{t-1} + a₂·X²_{t-2} + ... + aₚ·X²_{t-p}
W_t  = X_t / σ_t
```
Параметры `a₀...aₚ` подбираются так, чтобы минимизировать отклонение `{W_t}` от нормального распределения:
```
D² = S² + (K - 3)²
```
где `S` — skewness, `K` — kurtosis.

**Характер данных:**
- **Смена тренда / режима** — волатильность плавно растёт или падает, меняет направление
- Нет чёткого leverage-эффекта
- Нет кластеризации GARCH-типа (не «вспышка → затухание»)
- Распределение может отличаться от нормального (heavy tails)
- Model-free: никаких предположений о распределении, только нормализация

**Пример из реального мира:**
Стейблкоин-пара, где волатильность медленно «дышит» — то сжимается, то расширяется циклически. Или альткоин в переходе между фазами (накопление → рост → распределение) — параметрические модели не успевают за сменой режима, а NoVaS адаптируется через окно из p лагов.

**DGP в тестах:**
```
baseVol = 0.01
sigma_t = baseVol × (1 + 0.3 × sin(2π·t / 50))
```
Синусоидальная волатильность с периодом 50 свечей — плавно меняющийся тренд волатильности, который не укладывается ни в одну параметрическую модель.

---

## Сравнительная таблица

| Паттерн в данных | Лучшая модель | Почему |
|---|---|---|
| Симметричная кластеризация vol | GARCH | Минимум параметров, точная оценка |
| Сильный leverage (падения → vol↑↑) | EGARCH | Логарифмическая модель, `γ·z` захватывает асимметрию |
| Умеренный leverage | GJR-GARCH | Индикатор `I(r<0)` — проще EGARCH |
| Многомасштабная vol (day/week/month) | HAR-RV | Три горизонта в одной регрессии |
| Смена тренда / плавные режимы | NoVaS | Model-free, адаптируется через D²-нормализацию |

## Как predict() выбирает

```
predict(candles, interval)
  → fit GARCH, EGARCH, GJR-GARCH  → min AIC из трёх
  → fit HAR-RV                     → AIC (если сходится и persistence < 1)
  → fit NoVaS                      → AIC (если сходится и persistence < 1)
  → глобальный min AIC → лучшая модель
```

Никаких эвристик или порогов — чистый AIC.

**Важно:** на практике GARCH-семейство (MLE-based) часто выигрывает AIC у HAR-RV и NoVaS, потому что MLE даёт более точный log-likelihood. HAR-RV и NoVaS используют синтетический Gaussian LL, что ставит их в невыгодное положение по AIC. Поэтому HAR-RV и NoVaS выигрывают только когда их механизм существенно лучше описывает данные.
